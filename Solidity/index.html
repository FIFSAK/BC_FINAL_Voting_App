<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="./chatABI.js"></script>

  </head>
  <body>

    <script>
        console.log(window.ethereum);
        var chat;
        var userAccount;


        function startApp() {
            var chatAddress = "0x90230C05Dc1B8C12AA974ed00CEa0B069b79cd60";
            userAccount = Web3js.eth.accounts[0]
            getAccounts(function(result) {
                console.log(result[0]);
            });
            chat = new Web3js.eth.Contract(chatABI, chatAddress);
            getMessages().then(messages => console.log(messages))
            sendMessage("hello1").then(res => {
                console.log(res);
            })
        }

        function getAccounts(callback) {
            Web3.eth.getAccounts((error,result) => {
                if (error) {
                    console.log(error);
                } else {
                    callback(result);
                }
            });
        }

        function getMessages() {
            return chat.methods.getSt().call()
        }

        function sendMessage(message) {
            return chat.methods.add(message).send({
                gas: "1000000",
                from: userAccount
            })
        }





        window.addEventListener('load', function() {
            if (typeof Web3 !== 'undefined') {
                Web3js = new Web3('wss://rinkeby.infura.io/ws/v3/5760cba7b3f545b1912020131adea4c0');
            } else {
                return alert("Metamask extention is not installed. Please install Metamask extention and try again.");
            }
            startApp()
        })
    </script>
  </body>
</html>
